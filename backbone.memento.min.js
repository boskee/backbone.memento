(function(){"use strict";{var a;({}).hasOwnProperty}define(["backbone","underscore"],function(b,c){a=function(a,b){this.version="0.4.2",b=c.extend({ignore:[]},b);var d=new e(a,b),h=new f(a,b),i=function(a,b){a&&d.deserialize(a,b)};this.previousState=function(){return h.previous()},this.changes=function(){var a=this.attributes,b=this.previousState();return g.map(a,b)},this.store=function(){var a=d.serialize();h.push(a)},this.restore=function(a){var b=h.pop();i(b,a)},this.restart=function(a){var b=h.rewind();i(b,a)},this.consolidate=function(c){h=new f(a,b),this.store()}};var d=function(a){a instanceof b.Model?(this.removeAttr=function(b){a.unset(b)},this.restore=function(b){a.set(b)}):(this.removeAttr=function(b){a.remove(b)},this.restore=function(b){a.reset(b)})},e=function(a,b){function e(a,b){if(a=c.clone(a),b.hasOwnProperty("ignore")&&b.ignore.length>0)for(var d in b.ignore){var e=b.ignore[d];delete a[e]}return a}function f(a,b){var c=[];if(!a||!b)return c;for(var d in b)b.hasOwnProperty(d)&&(a.hasOwnProperty(d)||c.push(d));return c}function g(a,b){for(var c in b){var d=b[c];i.removeAttr(d)}}function h(b,c){var d=e(b,c),h=a.toJSON();h=e(h,c);var j=f(d,h);g(a,j),i.restore(d)}var i=new d(a);this.serialize=function(){var c=a.toJSON();return c=e(c,b)},this.deserialize=function(a,d){d=c.extend({},b,d),h(a,d)}},f=function(a,b){function c(){d=[]}var d;this.push=function(a){d.push(a)},this.previous=function(){return d[d.length-1]},this.pop=function(a){var b=d.pop();return b},this.rewind=function(){var a=d[0];return c(),a},c()},g=function(){return{VALUE_CREATED:"created",VALUE_UPDATED:"updated",VALUE_DELETED:"deleted",VALUE_UNCHANGED:"unchanged",map:function(a,b){if(c.isFunction(a)||c.isFunction(b))throw"Invalid argument. Function given, object expected.";if(this.isValue(a)||this.isValue(b)){var d={type:this.compareValues(a,b),data:b||a};return d.type==this.VALUE_CREATED||d.type==this.VALUE_UPDATED?d.data:void 0}var e={};for(var f in a)if(!c.isFunction(a[f])){var g=void 0;"undefined"!=typeof b[f]&&(g=b[f]);var h=this.map(g,a[f]);void 0!==h&&(e[f]=h)}return e},compareValues:function(a,b){return a===b?this.VALUE_UNCHANGED:"undefined"==typeof a?this.VALUE_CREATED:"undefined"==typeof b?this.VALUE_DELETED:this.VALUE_UPDATED},isValue:function(a){return!c.isObject(a)&&!c.isArray(a)}}}();return a})}).call(this);