!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],b):"function"==typeof require&&"object"==typeof exports?module.exports=b(require("underscore"),require("backbone")):a.Backbone.Memento=b(a._,a.Backbone)}(this,function(a,b){"use strict";var c=function(b,c){this.version="0.4.2",c=a.extend({ignore:[]},c);var d=new e(b,c),h=new f(b,c),i=function(a,b){a&&d.deserialize(a,b)};this.previousState=function(){return h.previous()},this.changes=function(){var a=this.attributes,b=this.previousState();return g.map(a,b)},this.store=function(){var a=d.serialize();h.push(a)},this.restore=function(a){var b=h.pop();i(b,a)},this.restart=function(a){var b=h.rewind();i(b,a)},this.consolidate=function(a){h=new f(b,c),this.store()}},d=function(a){a instanceof b.Model?(this.removeAttr=function(b){a.unset(b)},this.restore=function(b){a.set(b)}):(this.removeAttr=function(b){a.remove(b)},this.restore=function(b){a.reset(b)})},e=function(b,c){function e(b,c){if(b=a.clone(b),a.has(c,"ignore")&&c.ignore.length>0)for(var d in c.ignore){var e=c.ignore[d];delete b[e]}return b}function f(b,c){var d=[];if(!b||!c)return d;for(var e in c)a.has(c,e)&&!a.has(b,e)&&d.push(e);return d}function g(a,b){for(var c in b){var d=b[c];i.removeAttr(d)}}function h(a,c){var d=e(a,c),h=b.toJSON();h=e(h,c);var j=f(d,h);g(b,j),i.restore(d)}var i=new d(b);this.serialize=function(){var a=b.toJSON();return a=e(a,c)},this.deserialize=function(b,d){d=a.extend({},c,d),h(b,d)}},f=function(a,b){function c(){d=[]}var d;this.push=function(a){d.push(a)},this.previous=function(){return d[d.length-1]},this.pop=function(a){var b=d.pop();return b},this.rewind=function(){var a=d[0];return c(),a},c()},g=function(){return{VALUE_CREATED:"created",VALUE_UPDATED:"updated",VALUE_DELETED:"deleted",VALUE_UNCHANGED:"unchanged",map:function(b,c){if(a.isFunction(b)||a.isFunction(c))throw"Invalid argument. Function given, object expected.";if(this.isValue(b)||this.isValue(c)){var d={type:this.compareValues(b,c),data:c||b};return d.type==this.VALUE_CREATED||d.type==this.VALUE_UPDATED?d.data:void 0}var e={};for(var f in b)if(!a.isFunction(b[f])){var g=void 0;"undefined"!=typeof c[f]&&(g=c[f]);var h=this.map(g,b[f]);void 0!==h&&(e[f]=h)}return e},compareValues:function(a,b){return a===b?this.VALUE_UNCHANGED:"undefined"==typeof a?this.VALUE_CREATED:"undefined"==typeof b?this.VALUE_DELETED:this.VALUE_UPDATED},isValue:function(b){return!a.isObject(b)&&!a.isArray(b)}}}();return c});